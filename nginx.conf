server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 1. External APIs (Specific paths first)
    
    # Departments & Sections -> Extra Duty API
    location ~ ^/api/v1/(departments|sections) {
        proxy_pass http://192.168.1.40:2024;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Users -> Attendance API
    location /api/users {
        proxy_pass http://192.168.1.12:7575;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Django Backend (Local)
    # Matches /api/v1/ but NOT departments/sections (handled above by regex priority if placed correctly, 
    # but nginx regex takes precedence over prefix unless ^~ is used. 
    # Actually, regex locations are checked *after* prefix locations match, BUT if a regex matches, it wins.
    # So the regex location matches /api/v1/departments.
    # The prefix location /api/v1/ matches /api/v1/responses.
    
    location /api/v1/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. General Fallback -> ORCI Web Portal
    # Catches any other /api requests not handled above (e.g. /api/legacy)
    location /api/ {
        proxy_pass http://192.168.1.41;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy custom admin requests to the Django backend
    location /admin/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Proxy Django static files (for admin interface)
    # This matches the STATIC_URL = 'static/' in settings.py if served under domain.
    # But settings.py often uses /static/. 
    # If settings.py default is STATIC_URL = 'static/', it is relative. 
    # Assuming standard Django: /static/
    location /static/ {
        alias /app/static_collected/;
    }
}
