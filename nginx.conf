server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 1. External APIs (Specific paths first)
    
    # Departments & Sections -> Extra Duty API (192.168.1.40:2024)
    location ~ ^/api/v1/(departments|sections) {
        proxy_pass http://192.168.1.40:2024;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Users -> Attendance API (192.168.1.12:7575)
    location /api/users {
        proxy_pass http://192.168.1.12:7575;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Django Backend (Local)
    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. General Fallback -> ORCI Web Portal (192.168.1.41)
    # Note: Nginx matches specificity. /api/ matches /api/v1 unless regex used or logic enforced.
    # Since /api/v1/ is handled by the backend location above, we might need a specific location for the fallback 
    # if it's meant to catch /api/something_else.
    # Given the previous config, /api/ maps to backend.
    
    # If the user needs the fallback to 192.168.1.41 for *other* /api requests:
    # We can keep /api/ for backend, but if the backend 404s, we can't easily fallback in Nginx without Lua or custom errors.
    # However, setupProxy says: "Catches any other /api requests not handled above" -> 192.168.1.41.
    # But /api/v1 goes to Backend.
    # So /api/foo -> 192.168.1.41
    # /api/v1/foo -> Backend matching
    
    # I will stick to the specific definitions for now.
    # If standard /api/ goes to backend, and /api/users goes to 192.168.1.12, that covers the main cases.
    # I will add a location /api/fallback if needed, but 'location /api/' captures everything starting with /api/.
    # To split valid backend URLs vs fallback URLs in Nginx is hard without a list.
    # I will assume the explicit /api/v1/ is for backend, and /api/ is fallback?
    # setupProxy: app.use(createProxyMiddleware(path.startsWith('/api/v1')...)) -> Backend.
    # setupProxy: app.use('/api'...) -> Fallback.
    
    # So:
    # /api/v1/departments -> 192.168.1.40
    # /api/v1/... -> Backend
    # /api/users -> 192.168.1.12
    # /api/... -> Fallback (192.168.1.41)
    
    # Correct Nginx Config:
    
    # Specifics
    location /api/v1/departments { proxy_pass http://192.168.1.40:2024; }
    location /api/v1/sections { proxy_pass http://192.168.1.40:2024; }
    location /api/users { proxy_pass http://192.168.1.12:7575; }

    # Backend (Note: The backend is at /api/v1/, not just /api/)
    location /api/v1/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Fallback (Everything else under /api/)
    location /api/ {
        proxy_pass http://192.168.1.41;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy custom admin requests to the Django backend
    location /admin/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Proxy static files if needed (though Nginx serves frontend static files, Django static files might need a path)
    # Usually, we collect Django static files to a volume shared with Nginx, OR we serve them via WhiteNoise.
    # For this setup, I'll trust standard /api usage.
    # If the backend has static files (like for Admin), we need to route /static/admin/ etc to the backend or volume.
    
    location /django_static/ {
        alias /app/static/; 
    }
}
